

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Introduction to FLARE: Fast Learning of Atomistic Rare Events &mdash; flare 1.1.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Prepare your data" href="prepare_data.html" />
    <link rel="prev" title="Tutorials" href="tutorials.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> flare
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction to FLARE: Fast Learning of Atomistic Rare Events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Machine-learned-force-fields">Machine learned force fields</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Training-data">Training data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Training-a-GP-model.">Training a GP model.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Task:-Find-hyperparameters-that-give-a-positive-log-marginal-likelihood.">Task: Find hyperparameters that give a positive log marginal likelihood.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Solution">Solution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Optimizing-the-hyperparameters-rigorously">Optimizing the hyperparameters rigorously</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculating-the-learning-curve">Calculating the learning curve</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Learning-a-force-field-on-the-fly">Learning a force field on the fly</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#The-Lennard-Jones-Potential">The Lennard Jones Potential</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Perform-an-on-the-fly-training-simulation.">Perform an on-the-fly training simulation.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Step-1:-Set-up-the-initial-structure.">Step 1: Set up the initial structure.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Step-2:-Set-up-a-GP-model.">Step 2: Set up a GP model.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Step-3:-Set-up-an-OTF-training-object.">Step 3: Set up an OTF training object.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Step-4:-Perform-the-simulation!">Step 4: Perform the simulation!</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Parsing-the-OTF-output-file.">Parsing the OTF output file.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Comparing-the-learned-model-against-ground-truth.">Comparing the learned model against ground truth.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="prepare_data.html">Prepare your data</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpfa.html">Training a Gaussian Process from an AIMD Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="after_training.html">After Training</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../flare/flare.html">Python Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flare_pp/flare_pp.html">C++ Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../related.html">Applications/Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/contribute.html">How To Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">How to Cite</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">flare</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Introduction to FLARE: Fast Learning of Atomistic Rare Events</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/aps_tutorial.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Introduction-to-FLARE:-Fast-Learning-of-Atomistic-Rare-Events">
<h1>Introduction to FLARE: Fast Learning of Atomistic Rare Events<a class="headerlink" href="#Introduction-to-FLARE:-Fast-Learning-of-Atomistic-Rare-Events" title="Permalink to this headline">¶</a></h1>
<p>Jonathan Vandermause (<a class="reference external" href="mailto:jonathan_vandermause&#37;&#52;&#48;g&#46;harvard&#46;edu">jonathan_vandermause<span>&#64;</span>g<span>&#46;</span>harvard<span>&#46;</span>edu</a>)</p>
<p><strong>Learning objectives:</strong> * Train 2+3-body Gaussian process models on <em>ab initio</em> force data. * Use the uncertainties of the GP to train a force field on the fly.</p>
<p>Computing the properties of real materials with quantum mechanical accuracy is extremely expensive. One of the most efficient explicitly quantum mechanical tools we have for the job, density functional theory (or DFT), has a computational cost that scales cubically with the number of atoms in the system, and is therefore limited in practice to at most a few hundred atoms (with some hope of scaling further with orbital free DFT methods).</p>
<p>One of the most popular strategies for getting around this is to simply ignore the hard part of the problem—the electrons—and to instead try to model the system with an <em>empirical interatomic potential</em>, which expresses the potential energy as a sum over local, atom-centered contributions that depend only on atomic coordinates. The resulting model scales only linearly with the number of atoms, making it possible to simulate the behavior of hundreds of thousands or even millions of atoms over
microsecond timescales. The problem then becomes: how do you design a good potential? Is it possible to find a fast empirical potential with the accuracy of DFT?</p>
<p>FLARE is an open-source software that uses Bayesian machine learning to try to bridge the gap between accurate but slow quantum methods (like DFT) and fast but inaccurate classical methods (like empirical interatomic potentials). The idea is to train fast potentials on accurate DFT data, and ideally to do so in an automatic, closed loop fashion, so that a wide class of materials and material compositions can be efficiently explored. The key tool FLARE uses to accomplish this is Gaussian process
(GP) regression, an elegant framework for defining probability distributions over functions. In this tutorial, we’ll explore the use of GPs to model interactions between atoms in materials.</p>
<p>If you’re interested in learning more about the FLARE code, check out our <a class="reference external" href="https://www.nature.com/articles/s41524-020-0283-z">paper</a>, <a class="reference external" href="https://github.com/mir-group/flare">GitHub page</a>, and <a class="reference external" href="https://flare.readthedocs.io/en/latest/">code documentation</a>.</p>
<div class="section" id="Installation">
<h2>Installation<a class="headerlink" href="#Installation" title="Permalink to this headline">¶</a></h2>
<p>We can install FLARE and its dependencies here in Google Colab. (This will take about a minute.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span> pip install --upgrade mir-flare
</pre></div>
</div>
</div>
<p>Let’s check that it worked by trying to import FLARE:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">flare</span>
</pre></div>
</div>
</div>
<p>If you don’t see an error, you’re all set for the tutorial! Let’s also go ahead and import all the modules we’ll need now:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">flare</span> <span class="k">import</span> <span class="n">gp</span><span class="p">,</span> <span class="n">struc</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">otf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span>\
  <span class="n">otf_parser</span>
<span class="kn">from</span> <span class="nn">flare.kernels</span> <span class="k">import</span> <span class="n">mc_simple</span>
<span class="kn">from</span> <span class="nn">flare.utils</span> <span class="k">import</span> <span class="n">md_helper</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">ase.visualize</span> <span class="k">import</span> <span class="n">view</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Machine-learned-force-fields">
<h2>Machine learned force fields<a class="headerlink" href="#Machine-learned-force-fields" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Training-data">
<h3>Training data<a class="headerlink" href="#Training-data" title="Permalink to this headline">¶</a></h3>
<p>Let’s start by downloading some <em>ab initio</em> force data to play with.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># download ab initio MD data</span>
<span class="o">!</span> wget https://zenodo.org/record/3688843/files/AgI_data.zip?download<span class="o">=</span><span class="m">1</span>

<span class="c1"># unzip the folder</span>
<span class="o">!</span> unzip AgI_data.zip?download<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div>
<p>The folder “AgI_data” contains data from an <em>ab initio</em> molecular dynamics simulation of the fast-ion conductor silver iodide (AgI), where <em>ab initio</em> means “from the beginning” or “from first principles”. In other words, we simulate how the atoms move by calculating the quantum mechanical forces on the ions at every timestep using DFT. To give you a sense of how expensive that is, the ~2500 timesteps in this simulation (about 12 picoseconds of simulation time) required 2 days of wall time on
256 cpus. (And there were only 32 atoms in the simulation!)</p>
<p>Let’s load the positions, forces, cell, and species of the atoms in the simulation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># load AIMD training data</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;AgI_data/&#39;</span>
<span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s1">&#39;species.npy&#39;</span><span class="p">)</span>  <span class="c1"># atomic numbers of the atoms</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s1">&#39;positions.npy&#39;</span><span class="p">)</span>  <span class="c1"># in angstrom (A)</span>
<span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s1">&#39;cell.npy&#39;</span><span class="p">)</span>  <span class="c1"># 3x3 array of cell vectors (in A)</span>
<span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s1">&#39;forces.npy&#39;</span><span class="p">)</span>  <span class="c1"># in eV/A</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Training-a-GP-model.">
<h3>Training a GP model.<a class="headerlink" href="#Training-a-GP-model." title="Permalink to this headline">¶</a></h3>
<p>Let’s train a GP model on the data. We’ll first initialize a Gaussian process object, which involves choosing a kernel function and its gradient, an initial set of hyperparameters, and the cutoff radii of local environments. We’ll use a 2+3-body kernel, which compares local environments by comparing the pairs and triplets of atoms inside the environments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create a 2+3-body gaussian process object</span>
<span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;twobody&#39;</span><span class="p">,</span> <span class="s1">&#39;threebody&#39;</span><span class="p">]</span>
<span class="n">component</span> <span class="o">=</span> <span class="s1">&#39;mc&#39;</span>
<span class="n">hyps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>  <span class="c1"># initial (bad) choice of hyps</span>
<span class="n">cutoffs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;twobody&#39;</span><span class="p">:</span> <span class="mf">7.0</span><span class="p">,</span> <span class="s1">&#39;threebody&#39;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">}</span>  <span class="c1"># cutoff radii in A</span>
<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># max number of hyperparameter optimziation steps</span>

<span class="n">gp_model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">GaussianProcess</span><span class="p">(</span>
  <span class="n">kernels</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span>
  <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
  <span class="n">hyps</span><span class="o">=</span><span class="n">hyps</span><span class="p">,</span>
  <span class="n">cutoffs</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">,</span>
  <span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s put a couple of structures into the training set.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># put a few snapshots in the training set</span>
<span class="n">snapshots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">]</span>
<span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
    <span class="c1"># create flare structure</span>
    <span class="n">training_positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span>
    <span class="n">training_forces</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span>
    <span class="n">training_structure</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">training_positions</span><span class="p">)</span>

    <span class="c1"># add the structure to the training set of the GP</span>
    <span class="n">gp_model</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="n">training_structure</span><span class="p">,</span> <span class="n">training_forces</span><span class="p">)</span>

<span class="n">gp_model</span><span class="o">.</span><span class="n">set_L_alpha</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The “set_L_alpha” method updates the covariance matrix of the GP, computes the alpha vector used to make predictions, and computes the log marginal likelihood of the training data. Let’s see what that looks like:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">gp_model</span><span class="o">.</span><span class="n">likelihood</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-491.75669961275526
</pre></div></div>
</div>
<p>This is too low, suggesting that our initial guess for the hyperparameters was not a good one.</p>
</div>
<div class="section" id="Task:-Find-hyperparameters-that-give-a-positive-log-marginal-likelihood.">
<h3>Task: Find hyperparameters that give a positive log marginal likelihood.<a class="headerlink" href="#Task:-Find-hyperparameters-that-give-a-positive-log-marginal-likelihood." title="Permalink to this headline">¶</a></h3>
<p>Hint: For the 2+3-body kernel, the hyperparameters are in the following order: * Signal variance of the 2-body kernel (in eV) * Length scale of the 2-body kernel (in A) * Signal variance of the 3-body kernel (in eV) * Length scale of the 3-body kernel (in A) * Noise hyperparameter (in eV/A)</p>
<p>What is a plausible length scale for this problem? Note that machine learned force fields typically have errors in the range 50-200 meV/A, and the energy of a pair or triplet is much less than the total local energy assigned to an atom.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># your code here</span>

<span class="c1"># hint: reset the hyperparameters with gp_model.hyps = *new hyps*, then use</span>
<span class="c1"># set_L_alpha to recompute the likelihood</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Solution">
<h3>Solution<a class="headerlink" href="#Solution" title="Permalink to this headline">¶</a></h3>
<p>A reasonable guess for the length scale is 1 A, and since errors are often around 0.1 eV/A, we’ll choose that as our noise level. The signal variances require some tuning, but we should expect them to be significantly less than 1 eV, with the triplet contribution significantly smaller than the pair contribution.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gp_model</span><span class="o">.</span><span class="n">hyps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">set_L_alpha</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gp_model</span><span class="o">.</span><span class="n">likelihood</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
9.500574018895804
</pre></div></div>
</div>
</div>
<div class="section" id="Optimizing-the-hyperparameters-rigorously">
<h3>Optimizing the hyperparameters rigorously<a class="headerlink" href="#Optimizing-the-hyperparameters-rigorously" title="Permalink to this headline">¶</a></h3>
<p>The above was an exercise in manual hyperparameter tuning, which is tedious and should be avoided if possible. Because we can compute the gradient of the likelihood with respect to the hyperparameters, we can instead use a more principled gradient descent approach to find the best set of hyperparameters.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># optimize the hyperparameters (this will take some time!)</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">print_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In case you don’t want to wait, here are some good values:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gp_model</span><span class="o">.</span><span class="n">hyps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.59612454e-02</span><span class="p">,</span> <span class="mf">5.70104540e-01</span><span class="p">,</span> <span class="mf">6.01290125e-04</span><span class="p">,</span>
                          <span class="mf">9.17243358e-01</span><span class="p">,</span> <span class="mf">1.09666317e-01</span><span class="p">])</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">set_L_alpha</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gp_model</span><span class="o">.</span><span class="n">likelihood</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
71.16991245736048
</pre></div></div>
</div>
</div>
<div class="section" id="Calculating-the-learning-curve">
<h3>Calculating the learning curve<a class="headerlink" href="#Calculating-the-learning-curve" title="Permalink to this headline">¶</a></h3>
<p>Let’s get a feel for how much data the model needs by computing the learning curve, i.e.&nbsp;the performance on a validation set as a function of the number of training points. Let’s create training and validation structures drawn from the AIMD simulation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># choose a training snapshot</span>
<span class="n">training_snapshot</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">training_positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">training_snapshot</span><span class="p">]</span>
<span class="n">training_forces</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">training_snapshot</span><span class="p">]</span>
<span class="n">training_structure</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">training_positions</span><span class="p">)</span>

<span class="c1"># choose a validation snapshot</span>
<span class="n">validation_snapshot</span> <span class="o">=</span> <span class="mi">2300</span>
<span class="n">validation_positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">validation_snapshot</span><span class="p">]</span>
<span class="n">validation_forces</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">validation_snapshot</span><span class="p">]</span>
<span class="n">validation_structure</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">validation_positions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We now loop over the atomic environments in the training structure and add them one by one to the training set of the GP model. After adding an environment, we predict all the forces on the validation structure and compute the MAE. We’ll also time the prediction step to get a feel for how the cost of GP predictions depends on the size of the training set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># reset the gp with hyperparameters fixed to the optimized values</span>
<span class="n">hyps_final</span> <span class="o">=</span> <span class="n">gp_model</span><span class="o">.</span><span class="n">hyps</span>
<span class="n">gp_model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">GaussianProcess</span><span class="p">(</span>
  <span class="n">kernels</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span>
  <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
  <span class="n">hyps</span><span class="o">=</span><span class="n">hyps</span><span class="p">,</span>
  <span class="n">cutoffs</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">,</span>
  <span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">hyps</span> <span class="o">=</span> <span class="n">hyps_final</span>

<span class="c1"># add atomic environments one by one to the training set</span>
<span class="n">n_atoms</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># number of atoms in the structure</span>
<span class="n">validation_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span>
<span class="n">prediction_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span>
<span class="n">validation_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computing validation errors...&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)):</span>
    <span class="c1"># add the current atomic environment to the training set</span>
    <span class="n">gp_model</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="n">training_structure</span><span class="p">,</span> <span class="n">training_forces</span><span class="p">,</span>
                        <span class="n">custom_range</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="p">])</span>
    <span class="n">gp_model</span><span class="o">.</span><span class="n">set_L_alpha</span><span class="p">()</span>

    <span class="c1"># predict the forces on the validation structure</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pred_forces</span><span class="p">,</span> <span class="n">stds</span> <span class="o">=</span> \
        <span class="n">predict</span><span class="o">.</span><span class="n">predict_on_structure</span><span class="p">(</span><span class="n">validation_structure</span><span class="p">,</span> <span class="n">gp_model</span><span class="p">)</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred_forces</span> <span class="o">-</span> <span class="n">validation_forces</span><span class="p">))</span>
    <span class="n">validation_errors</span><span class="p">[</span><span class="n">validation_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">mae</span>
    <span class="n">prediction_times</span><span class="p">[</span><span class="n">validation_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">time1</span> <span class="o">-</span> <span class="n">time0</span>
    <span class="n">validation_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
computing validation errors...
0.315073761272364
0.29588515439108337
0.3234313322939279
0.29323785059806706
0.20129532813447323
0.19131142668143372
0.1827709765647784
0.17610478136490326
0.16902120241436183
0.17466172091548085
0.16829757387913633
0.16823160886145053
0.1797266370933175
0.17570045468126091
0.1778018841113225
0.16181457527423726
0.15221658747132247
0.151463002400943
0.15330262545396417
0.14366990594229426
0.13955981466966869
0.1386958938185947
0.13337032134291107
0.13856470639127907
0.13934854695295343
0.1384439054077334
0.1376182149699538
0.1398980197468981
0.13878505117526346
0.13947592439212986
0.14140188721074384
0.14095157040791634
</pre></div></div>
</div>
<p>Let’s make a plot of the results.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">validation_errors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of training environments&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mae on validation structure (eV/$\AA$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prediction_times</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of training environments&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;prediction wall time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_aps_tutorial_48_0.png" src="../_images/tutorials_aps_tutorial_48_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_aps_tutorial_48_1.png" src="../_images/tutorials_aps_tutorial_48_1.png" />
</div>
</div>
<p>Notice that the prediction time grows roughly linearly with the number of training environments.</p>
</div>
</div>
<div class="section" id="Learning-a-force-field-on-the-fly">
<h2>Learning a force field on the fly<a class="headerlink" href="#Learning-a-force-field-on-the-fly" title="Permalink to this headline">¶</a></h2>
<div class="section" id="The-Lennard-Jones-Potential">
<h3>The Lennard Jones Potential<a class="headerlink" href="#The-Lennard-Jones-Potential" title="Permalink to this headline">¶</a></h3>
<p>In production FLARE runs, we make calls to a DFT solver like Quantum Espresso, VASP, or CP2K whenever the uncertainty on a force component is unacceptably high. In principle, the forces can come from anywhere, and FLARE allows users to write a custom solver that returns forces on an arbitrary input structure.</p>
<p>Here, we’ll define a simple custom solver that returns Lennard Jones forces, and then try to reconstruct the potential on the fly.</p>
<p>The Lennard Jones potential takes the following form: <span class="math">\begin{equation}
V_{\text{LJ}} = 4\epsilon \left[ \left(\frac{\sigma}{r} \right)^{12} - \left(\frac{\sigma}{r}\right)^{6} \right].
\end{equation}</span></p>
<p>Let’s define our custom solver. To do this, we need to create a class with two methods:</p>
<ul class="simple">
<li>parse_dft_input: Takes the name of an input file, and returns the positions, species, cell, and masses of the atoms specified in the input file.</li>
<li>run_dft_par: Takes a FLARE structure and an optional dictionary of keywords, and returns the forces on the atoms.</li>
</ul>
<p>We’ll make a multi-species Lennard Jones function, which allows different values of <span class="math">\sigma</span> and <span class="math">\epsilon</span> for different pairs of species. We’ll store these as 2-D numpy arrays, so that, e.g., the <span class="math">\sigma</span> value assigned to species 1 and 3 is stored in element (1, 3) of this array.</p>
<p>The derivative of the Lennard Jones potential with respect to <span class="math">r</span> is:</p>
<p><span class="math">\begin{equation}
\frac{dV_{\text{LJ}}}{dr} = 4\epsilon \left[ -\frac{12 \sigma^{12}}{r^{13}} +\frac{6 \sigma^6}{r^7} \right].
\end{equation}</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_LJ_forces</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">lj_parameters</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Calculate multicomponent Lennard Jones forces on a structure of atoms.</span>
<span class="sd">  dft_kwargs is assumed to be a dictionary containing the cutoff, an ordered</span>
<span class="sd">  list of species, and arrays containing epsilon and sigma values.&quot;&quot;&quot;</span>

  <span class="n">cutoff</span> <span class="o">=</span> <span class="n">lj_parameters</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span>
  <span class="n">epsilons</span> <span class="o">=</span> <span class="n">lj_parameters</span><span class="p">[</span><span class="s1">&#39;epsilons&#39;</span><span class="p">]</span>
  <span class="n">sigmas</span> <span class="o">=</span> <span class="n">lj_parameters</span><span class="p">[</span><span class="s1">&#39;sigmas&#39;</span><span class="p">]</span>
  <span class="n">spec_list</span> <span class="o">=</span> <span class="n">lj_parameters</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>

  <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">structure</span><span class="o">.</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="c1"># Loop over atoms in the structure.</span>
  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">nat</span><span class="p">):</span>
      <span class="c1"># Create atomic environment.</span>
      <span class="n">environment</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">AtomicEnvironment</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cutoff</span><span class="p">]))</span>
      <span class="n">ind1</span> <span class="o">=</span> <span class="n">spec_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span>

      <span class="c1"># Loop over atoms in the environment to compute the total force.</span>
      <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">etypes</span><span class="p">)):</span>
          <span class="n">ind2</span> <span class="o">=</span> <span class="n">spec_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">etypes</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
          <span class="n">eps</span> <span class="o">=</span> <span class="n">epsilons</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">]</span>
          <span class="n">sig</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">]</span>

          <span class="c1"># Compute LJ force.</span>
          <span class="n">bond_vals</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">bond_array_2</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">bond_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

          <span class="n">dE_dr</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">12</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mi">13</span><span class="p">)</span> <span class="o">+</span>
                             <span class="mi">6</span> <span class="o">*</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mi">7</span><span class="p">))</span>

          <span class="n">forces</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dE_dr</span> <span class="o">*</span> <span class="n">bond_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">forces</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dE_dr</span> <span class="o">*</span> <span class="n">bond_vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
          <span class="n">forces</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dE_dr</span> <span class="o">*</span> <span class="n">bond_vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">forces</span>
</pre></div>
</div>
</div>
<p>We can use our Lennard Jones force function to define a custom module.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create lj module</span>
<span class="k">class</span> <span class="nc">lj_module</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">parse_dft_input</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;We assume the input is a pickled dictionary containing positions</span>
<span class="sd">      (in angstrom), species (as a list of strings), cell (as a 3x3 matrix of</span>
<span class="sd">      cell vectors), and masses (as a dictionary assigning each species a mass</span>
<span class="sd">      in AMU).&quot;&quot;&quot;</span>

      <span class="n">input_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
      <span class="n">struc_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
      <span class="n">input_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

      <span class="c1"># Convert masses to MD units (energy = eV, length = A, )</span>
      <span class="n">masses</span> <span class="o">=</span> <span class="n">struc_dict</span><span class="p">[</span><span class="s1">&#39;masses&#39;</span><span class="p">]</span>
      <span class="n">mass_convert</span> <span class="o">=</span> <span class="mf">0.000103642695727</span>
      <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">masses</span><span class="p">:</span>
          <span class="n">masses</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mass_convert</span>

      <span class="k">return</span> <span class="n">struc_dict</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">],</span> <span class="n">struc_dict</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span> \
          <span class="n">struc_dict</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">masses</span>

  <span class="k">def</span> <span class="nf">run_dft_par</span><span class="p">(</span><span class="n">dft_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dft_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">npool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dft_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dft_out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_LJ_forces</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">dft_kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create dictionary of lj parameters</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">epsilons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]])</span>
<span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.9</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">]])</span>
<span class="n">spec_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">]</span>  <span class="c1"># silver and iodine atomic numbers</span>

<span class="n">lj_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">,</span> <span class="s1">&#39;epsilons&#39;</span><span class="p">:</span> <span class="n">epsilons</span><span class="p">,</span> <span class="s1">&#39;sigmas&#39;</span><span class="p">:</span> <span class="n">sigmas</span><span class="p">,</span>
             <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="n">spec_list</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create structures of 2 atoms, and plot the force on the second atom</span>
<span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">seps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">],</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">],</span> <span class="p">[</span><span class="mi">53</span><span class="p">,</span> <span class="mi">53</span><span class="p">]]</span>
<span class="n">store_frcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seps</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">sep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seps</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">sep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">spec_curr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">struc_curr</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">spec_curr</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="n">frcs</span> <span class="o">=</span> \
            <span class="n">lj_module</span><span class="o">.</span><span class="n">run_dft_par</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">struc_curr</span><span class="p">,</span> <span class="n">dft_kwargs</span><span class="o">=</span><span class="n">lj_params</span><span class="p">)</span>
        <span class="n">store_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">frcs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="n">store_frcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sig = 2.0, eps = 3.0&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="n">store_frcs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sig = 1.5, eps = 1.8&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="n">store_frcs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sig = 1.0, eps = 1.0&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;separation ($\AA$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;force (eV/$\AA$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_aps_tutorial_64_0.png" src="../_images/tutorials_aps_tutorial_64_0.png" />
</div>
</div>
</div>
<div class="section" id="Perform-an-on-the-fly-training-simulation.">
<h3>Perform an on-the-fly training simulation.<a class="headerlink" href="#Perform-an-on-the-fly-training-simulation." title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="Step-1:-Set-up-the-initial-structure.">
<h3>Step 1: Set up the initial structure.<a class="headerlink" href="#Step-1:-Set-up-the-initial-structure." title="Permalink to this headline">¶</a></h3>
<p>Let’s create a bcc (body centered cubic) Lennard Jones crystal.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create bcc unit cell</span>
<span class="n">alat</span> <span class="o">=</span> <span class="mf">2.54</span>
<span class="n">unit_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">alat</span>

<span class="c1"># define bcc positions</span>
<span class="n">unit_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                           <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">]])</span> <span class="o">*</span> <span class="n">alat</span>

<span class="c1"># make a supercell</span>
<span class="n">sc_size</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">md_helper</span><span class="o">.</span><span class="n">get_supercell_positions</span><span class="p">(</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">unit_cell</span><span class="p">,</span> <span class="n">unit_positions</span><span class="p">)</span>
<span class="n">cell</span> <span class="o">=</span> <span class="n">unit_cell</span> <span class="o">*</span> <span class="n">sc_size</span>

<span class="c1"># jitter positions to give nonzero force on first frame</span>
<span class="k">for</span> <span class="n">atom_pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">atom_pos</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>

<span class="c1"># create initial structure</span>
<span class="n">species</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sc_size</span> <span class="o">**</span> <span class="mi">3</span>
<span class="n">struc_curr</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>

<span class="c1"># create pseudo input file</span>
<span class="n">mass_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Ag&#39;</span><span class="p">:</span> <span class="mi">108</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">127</span><span class="p">}</span>
<span class="n">input_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">positions</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="n">species</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span> <span class="n">cell</span><span class="p">,</span>
                    <span class="s1">&#39;masses&#39;</span><span class="p">:</span> <span class="n">mass_dictionary</span><span class="p">}</span>
<span class="n">input_file_name</span> <span class="o">=</span> <span class="s1">&#39;lj.in&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">,</span> <span class="n">input_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># view the structure</span>
<span class="n">view</span><span class="p">(</span><span class="n">struc_curr</span><span class="o">.</span><span class="n">to_ase_atoms</span><span class="p">(),</span> <span class="n">viewer</span><span class="o">=</span><span class="s1">&#39;x3d&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<html>

 <head>

  <title>ASE atomic visualization</title>

  <link rel="stylesheet" type="text/css"

   href="https://www.x3dom.org/x3dom/release/x3dom.css">

  </link>

  <script type="text/javascript"

   src="https://www.x3dom.org/x3dom/release/x3dom.js">

  </script>

 </head>

 <body>

  <X3D>

   <Scene>

    <Transform translation="0.01 -0.05 -0.01">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.26 1.30 1.27">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.04 -0.00 2.56">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.29 1.29 3.83">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.03 -0.00 5.08">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.26 1.23 6.31">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.04 2.52 0.04">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.23 3.85 1.30">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-0.01 2.56 2.57">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.28 3.77 3.85">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.01 2.54 5.09">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.26 3.82 6.40">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-0.00 5.11 0.03">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.28 6.34 1.27">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="0.01 5.11 2.55">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.30 6.34 3.83">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="-0.02 5.11 5.06">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="1.30 6.30 6.37">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.54 0.03 0.04">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.79 1.27 1.31">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.57 0.03 2.56">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.76 1.26 3.80">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.49 -0.00 5.13">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.78 1.31 6.31">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.56 2.54 0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.79 3.82 1.29">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.50 2.51 2.55">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.85 3.77 3.76">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.57 2.57 5.06">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.79 3.80 6.35">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.54 5.04 -0.02">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.80 6.39 1.24">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.58 5.08 2.54">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.77 6.40 3.82">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="2.55 5.06 5.07">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="3.85 6.30 6.32">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.10 -0.05 -0.00">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.32 1.26 1.23">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.06 -0.02 2.56">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.38 1.26 3.82">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.10 -0.02 5.10">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.37 1.24 6.30">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.10 2.55 0.01">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.35 3.76 1.30">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.10 2.51 2.49">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.31 3.83 3.81">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.09 2.58 5.06">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.38 3.82 6.35">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.07 5.05 -0.01">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.36 6.37 1.23">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.12 5.11 2.52">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.39 6.37 3.79">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="5.12 5.09 5.12">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.753 0.753 0.753" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.45">

      </Sphere>

     </Shape>

    </Transform>

    <Transform translation="6.31 6.37 6.36">

     <Shape>

      <Appearance>

       <Material diffuseColor="0.580 0.000 0.580" specularColor="0.5 0.5 0.5">

       </Material>

      </Appearance>

      <Sphere radius="1.39">

      </Sphere>

     </Shape>

    </Transform>

   </Scene>

  </X3D>

 </body>

</html></div>
</div>
</div>
<div class="section" id="Step-2:-Set-up-a-GP-model.">
<h3>Step 2: Set up a GP model.<a class="headerlink" href="#Step-2:-Set-up-a-GP-model." title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create gaussian process model</span>
<span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;twobody&#39;</span><span class="p">]</span>
<span class="n">component</span> <span class="o">=</span> <span class="s1">&#39;mc&#39;</span>
<span class="n">hyps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">])</span>
<span class="n">hyp_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;Length Scale&#39;</span><span class="p">,</span> <span class="s1">&#39;Noise&#39;</span><span class="p">]</span>
<span class="n">cutoffs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;twobody&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">}</span>
<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">gp_model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">GaussianProcess</span><span class="p">(</span>
  <span class="n">kernels</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span>
  <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
  <span class="n">hyps</span><span class="o">=</span><span class="n">hyps</span><span class="p">,</span>
  <span class="n">hyp_labels</span><span class="o">=</span><span class="n">hyp_labels</span><span class="p">,</span>
  <span class="n">cutoffs</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">,</span>
  <span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Step-3:-Set-up-an-OTF-training-object.">
<h3>Step 3: Set up an OTF training object.<a class="headerlink" href="#Step-3:-Set-up-an-OTF-training-object." title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create otf object</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># time step (ps)</span>
<span class="n">number_of_steps</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">dft_loc</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># path to dft executable would usually go here</span>
<span class="n">std_tolerance_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="c1"># 10 meV/A</span>
<span class="n">init_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>  <span class="c1"># initial atoms added to the training set</span>
<span class="n">max_atoms_added</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># number of atoms added when dft is called</span>
<span class="n">freeze_hyps</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># no hyperparameter optimization after this many updates</span>

<span class="c1"># rescale the temperature halfway through the simulation</span>
<span class="n">rescale_steps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># rescale at step 10</span>
<span class="n">rescale_temps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">]</span>

<span class="n">otf_model</span> <span class="o">=</span> <span class="n">otf</span><span class="o">.</span><span class="n">OTF</span><span class="p">(</span>
    <span class="c1"># MD arguments</span>
    <span class="n">dt</span><span class="p">,</span>
    <span class="n">number_of_steps</span><span class="p">,</span>
    <span class="n">rescale_steps</span><span class="o">=</span><span class="n">rescale_steps</span><span class="p">,</span>
    <span class="n">rescale_temps</span><span class="o">=</span><span class="n">rescale_temps</span><span class="p">,</span>
    <span class="c1"># FLARE arguments</span>
    <span class="n">gp</span><span class="o">=</span><span class="n">gp_model</span><span class="p">,</span>
    <span class="c1"># OTF arguments</span>
    <span class="n">std_tolerance_factor</span><span class="o">=</span><span class="n">std_tolerance_factor</span><span class="p">,</span>
    <span class="n">init_atoms</span><span class="o">=</span><span class="n">init_atoms</span><span class="p">,</span>
    <span class="n">max_atoms_added</span><span class="o">=</span><span class="n">max_atoms_added</span><span class="p">,</span>
    <span class="n">freeze_hyps</span><span class="o">=</span><span class="n">freeze_hyps</span><span class="p">,</span>
    <span class="c1"># DFT arguments</span>
    <span class="n">force_source</span><span class="o">=</span><span class="n">lj_module</span><span class="p">,</span>
    <span class="n">dft_loc</span><span class="o">=</span><span class="n">dft_loc</span><span class="p">,</span>
    <span class="n">dft_input</span><span class="o">=</span><span class="n">input_file_name</span><span class="p">,</span>
    <span class="n">dft_kwargs</span><span class="o">=</span><span class="n">lj_params</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Step-4:-Perform-the-simulation!">
<h3>Step 4: Perform the simulation!<a class="headerlink" href="#Step-4:-Perform-the-simulation!" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># perform flare run (this will take about 2.5 minutes)</span>
<span class="n">otf_model</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Parsing-the-OTF-output-file.">
<h3>Parsing the OTF output file.<a class="headerlink" href="#Parsing-the-OTF-output-file." title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># parse output file</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;otf_run.out&#39;</span>
<span class="n">otf_trajectory</span> <span class="o">=</span> <span class="n">otf_parser</span><span class="o">.</span><span class="n">OtfAnalysis</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

<span class="c1"># plot temperature vs. simulation time</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">otf_trajectory</span><span class="o">.</span><span class="n">times</span>
<span class="n">temps</span> <span class="o">=</span> <span class="n">otf_trajectory</span><span class="o">.</span><span class="n">thermostat</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">dft_times</span> <span class="o">=</span> <span class="n">otf_trajectory</span><span class="o">.</span><span class="n">dft_times</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># exclude t = 0</span>

<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">dft_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dft_times</span><span class="p">):</span>
    <span class="n">otf_ind</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dft_time</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dft_times</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">temps</span><span class="p">[</span><span class="n">otf_ind</span><span class="p">],</span> <span class="s1">&#39;kx&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">temps</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (ps)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;temperature (K)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_aps_tutorial_77_0.png" src="../_images/tutorials_aps_tutorial_77_0.png" />
</div>
</div>
</div>
<div class="section" id="Comparing-the-learned-model-against-ground-truth.">
<h3>Comparing the learned model against ground truth.<a class="headerlink" href="#Comparing-the-learned-model-against-ground-truth." title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create structures of 2 atoms, and plot the force on the second atom</span>
<span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">seps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">],</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">],</span> <span class="p">[</span><span class="mi">53</span><span class="p">,</span> <span class="mi">53</span><span class="p">]]</span>
<span class="n">store_frcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seps</span><span class="p">)))</span>
<span class="n">gp_frcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seps</span><span class="p">)))</span>
<span class="n">gp_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seps</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">sep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seps</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">sep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">spec_curr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">struc_curr</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">spec_curr</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="n">env_curr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">AtomicEnvironment</span><span class="p">(</span><span class="n">struc_curr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cutoff</span><span class="p">]))</span>
        <span class="n">frcs</span> <span class="o">=</span> \
            <span class="n">lj_module</span><span class="o">.</span><span class="n">run_dft_par</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">struc_curr</span><span class="p">,</span> <span class="n">dft_kwargs</span><span class="o">=</span><span class="n">lj_params</span><span class="p">)</span>
        <span class="n">store_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">frcs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># predict the x component of the force</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">gp_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">env_curr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">gp_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
        <span class="n">gp_stds</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

<span class="c1"># plot GP predictions vs ground truth</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="n">store_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="n">gp_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="n">gp_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">gp_stds</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                     <span class="n">gp_frcs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">gp_stds</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;separation ($\AA$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;force (eV/$\AA$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_aps_tutorial_79_0.png" src="../_images/tutorials_aps_tutorial_79_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="prepare_data.html" class="btn btn-neutral float-right" title="Prepare your data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorials.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Jonathan Vandermause, Yu Xie, Anders Johansson, Cameron Owen

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>